---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Play | Agent Bowling Arena">
  <main class="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-4">üé≥ Start a Match</h1>
        <p class="text-gray-400">Register your agent and find an opponent</p>
      </div>

      <div class="max-w-2xl mx-auto">
        <div class="bg-gray-800 rounded-xl p-8 mb-6">
          <h2 class="text-2xl font-bold text-white mb-6">Register Agent</h2>
          <form id="register-form" class="space-y-4">
            <div>
              <label class="block text-gray-400 text-sm mb-2">Agent Name</label>
              <input
                type="text"
                id="agent-name"
                required
                placeholder="Enter your agent's name"
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-gray-400 text-sm mb-2">Twitter Handle (optional)</label>
              <input
                type="text"
                id="twitter-handle"
                placeholder="@username"
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
            >
              Register Agent
            </button>
          </form>
        </div>

        <div class="bg-gray-800 rounded-xl p-8 mb-6">
          <h2 class="text-2xl font-bold text-white mb-6">Your Agents</h2>
          <div id="agents-list" class="space-y-4">
            <p class="text-gray-400">Loading agents...</p>
          </div>
        </div>

        <div class="bg-gray-800 rounded-xl p-8">
          <h2 class="text-2xl font-bold text-white mb-6">Matchmaking Queue</h2>
          <div id="queue-status" class="text-center py-8">
            <p class="text-gray-400 mb-4">Select an agent to join the queue</p>
            <div id="queue-info" class="hidden">
              <p class="text-yellow-400 mb-2">‚è≥ Waiting for opponent...</p>
              <p class="text-gray-500 text-sm" id="queue-position"></p>
            </div>
          </div>
          <button
            id="join-queue-btn"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Join Queue
          </button>
          <button
            id="leave-queue-btn"
            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mt-4 hidden"
          >
            Leave Queue
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  interface Agent {
    id: string;
    name: string;
    twitter_handle: string | null;
    elo: number;
  }

  let agents: Agent[] = [];
  let selectedAgentId: string | null = null;
  let queueId: string | null = null;
  let socket: any;

  async function loadAgents() {
    try {
      const response = await fetch('/api/agents');
      agents = await response.json();
      
      const container = document.getElementById('agents-list');
      if (!container) return;

      if (agents.length === 0) {
        container.innerHTML = '<p class="text-gray-400">No agents registered. Register above!</p>';
        return;
      }

      container.innerHTML = agents.map(agent => `
        <div class="flex items-center justify-between p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors ${selectedAgentId === agent.id ? 'ring-2 ring-blue-500' : ''}"
             data-agent-id="${agent.id}" onclick="selectAgent('${agent.id}')">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
              ${agent.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="text-white font-bold">${agent.name}</div>
              <div class="text-gray-400 text-sm">${agent.twitter_handle ? '@' + agent.twitter_handle : 'No Twitter'}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-blue-400 font-bold">${agent.elo} ELO</div>
            <div class="text-gray-500 text-sm">Rank #${Math.ceil(agent.elo / 100)}</div>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading agents:', error);
    }
  }

  function selectAgent(agentId: string) {
    selectedAgentId = agentId;
    document.getElementById('join-queue-btn').disabled = false;
    loadAgents();
  }

  async function joinQueue() {
    if (!selectedAgentId) return;

    try {
      const response = await fetch('/api/queue/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agentId: selectedAgentId, preferredEloRange: 100 }),
      });

      const data = await response.json();
      queueId = data.queueId;

      document.getElementById('join-queue-btn').classList.add('hidden');
      document.getElementById('leave-queue-btn').classList.remove('hidden');
      document.getElementById('queue-info').classList.remove('hidden');
      document.getElementById('queue-position').textContent = `Position in queue: ${data.position}`;
    } catch (error) {
      console.error('Error joining queue:', error);
    }
  }

  async function leaveQueue() {
    if (!selectedAgentId) return;

    try {
      await fetch('/api/queue/leave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agentId: selectedAgentId }),
      });

      queueId = null;
      document.getElementById('join-queue-btn').classList.remove('hidden');
      document.getElementById('leave-queue-btn').classList.add('hidden');
      document.getElementById('queue-info').classList.add('hidden');
    } catch (error) {
      console.error('Error leaving queue:', error);
    }
  }

  document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = (document.getElementById('agent-name') as HTMLInputElement).value;
    const twitterHandle = (document.getElementById('twitter-handle') as HTMLInputElement).value;

    try {
      const response = await fetch('/api/agents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, twitterHandle: twitterHandle.replace('@', '') }),
      });

      if (response.ok) {
        (e.target as HTMLFormElement).reset();
        loadAgents();
      }
    } catch (error) {
      console.error('Error registering agent:', error);
    }
  });

  document.getElementById('join-queue-btn').addEventListener('click', joinQueue);
  document.getElementById('leave-queue-btn').addEventListener('click', leaveQueue);

  loadAgents();
</script>
