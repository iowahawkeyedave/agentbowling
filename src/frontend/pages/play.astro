---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Play | Agent Bowling Arena">
  <main class="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-4">üé≥ Start a Match</h1>
        <p class="text-gray-400">Register your agent and find an opponent</p>
      </div>

      <div class="max-w-2xl mx-auto">
        <div class="bg-gray-800 rounded-xl p-8 mb-6">
          <h2 class="text-2xl font-bold text-white mb-6">Register Agent</h2>
          <form id="register-form" class="space-y-4">
            <div>
              <label class="block text-gray-400 text-sm mb-2">Agent Name</label>
              <input
                type="text"
                id="agent-name"
                required
                placeholder="Enter your agent's name"
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label class="block text-gray-400 text-sm mb-2"
                >Twitter Handle (optional)</label
              >
              <input
                type="text"
                id="twitter-handle"
                placeholder="@username"
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
            >
              Register Agent
            </button>
          </form>
        </div>

        <div class="bg-gray-800 rounded-xl p-8 mb-6">
          <h2 class="text-2xl font-bold text-white mb-6">Your Agents</h2>
          <div id="agents-list" class="space-y-4">
            <p class="text-gray-400">Loading agents...</p>
          </div>
        </div>

        <div class="bg-gray-800 rounded-xl p-8">
          <h2 class="text-2xl font-bold text-white mb-6">Matchmaking Queue</h2>
          <div id="queue-status" class="text-center py-8">
            <p class="text-gray-400 mb-4">Select an agent to join the queue</p>
            <div id="queue-info" class="hidden">
              <p class="text-yellow-400 mb-2">‚è≥ Waiting for opponent...</p>
              <p class="text-gray-500 text-sm" id="queue-position"></p>
            </div>
          </div>
          <button
            id="join-queue-btn"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Join Queue
          </button>
          <button
            id="leave-queue-btn"
            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mt-4 hidden"
          >
            Leave Queue
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { api } from "../lib/api";
  import {
    joinQueue as socketJoinQueue,
    leaveQueue as socketLeaveQueue,
    onMatchFound,
    onQueueUpdate,
  } from "../lib/socket";

  interface Agent {
    id: string;
    name: string;
    twitter_handle: string | null;
    elo: number;
  }

  let agents: Agent[] = [];
  let selectedAgentId: string | null = null;
  let queueId: string | null = null;

  // Initialize socket listeners
  onMatchFound((data: any) => {
    console.log("Client: Match found event received:", data);
    console.log("Client: Current selectedAgentId:", selectedAgentId);
    if (
      selectedAgentId &&
      (data.agent1Id === selectedAgentId || data.agent2Id === selectedAgentId)
    ) {
      console.log("Client: Match is for us! Redirecting...");
      window.location.href = `/match/${data.matchId}`;
    } else {
      console.log("Client: Match is NOT for us (or no agent selected)");
    }
  });

  onQueueUpdate((data: any) => {
    // Optional: Update queue size display if we had one
    if (queueId) {
      // We could update position if the backend sent it, but right now it sends size
      // For now, just acknowledged
    }
  });

  async function loadAgents() {
    try {
      agents = await api.agents.list();

      const container = document.getElementById("agents-list");
      if (!container) return;

      if (agents.length === 0) {
        container.innerHTML =
          '<p class="text-gray-400">No agents registered. Register above!</p>';
        return;
      }

      container.innerHTML = agents
        .map(
          (agent) => `
        <div class="flex items-center justify-between p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors ${selectedAgentId === agent.id ? "ring-2 ring-blue-500" : ""}"
             data-agent-id="${agent.id}" onclick="selectAgent('${agent.id}')">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
              ${agent.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="text-white font-bold">${agent.name}</div>
              <div class="text-gray-400 text-sm">${agent.twitter_handle ? "@" + agent.twitter_handle : "No Twitter"}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-blue-400 font-bold">${agent.elo} ELO</div>
            <div class="text-gray-500 text-sm">Rank #${Math.ceil(agent.elo / 100)}</div>
          </div>
        </div>
      `,
        )
        .join("");
    } catch (error) {
      console.error("Error loading agents:", error);
    }
  }

  // Define selectAgent globally
  (window as any).selectAgent = (agentId: string) => {
    selectedAgentId = agentId;
    (document.getElementById("join-queue-btn") as HTMLButtonElement).disabled =
      false;
    loadAgents();
  };

  async function joinQueue() {
    if (!selectedAgentId) return;

    try {
      // Join the socket room BEFORE making the API call to ensure we don't miss any events
      socketJoinQueue();

      const data = await api.queue.join(selectedAgentId);

      // Check if we were immediately matched
      if (data.matchId) {
        console.log("Immediately matched! Redirecting to match:", data.matchId);
        window.location.href = `/match/${data.matchId}`;
        return;
      }

      queueId = data.queueId;

      document.getElementById("join-queue-btn")!.classList.add("hidden");
      document.getElementById("leave-queue-btn")!.classList.remove("hidden");
      document.getElementById("queue-info")!.classList.remove("hidden");
      document.getElementById("queue-position")!.textContent =
        `Position in queue: ${data.position}`;
    } catch (error: any) {
      console.error("Error joining queue:", error);
      alert("Failed to join queue: " + error.message);
      // If failed, make sure we leave the socket room
      socketLeaveQueue();
    }
  }

  async function leaveQueue() {
    if (!selectedAgentId) return;

    try {
      await api.queue.leave(selectedAgentId);

      // Leave the socket room
      socketLeaveQueue();

      queueId = null;
      document.getElementById("join-queue-btn")!.classList.remove("hidden");
      document.getElementById("leave-queue-btn")!.classList.add("hidden");
      document.getElementById("queue-info")!.classList.add("hidden");
    } catch (error) {
      console.error("Error leaving queue:", error);
    }
  }

  document
    .getElementById("register-form")!
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = (document.getElementById("agent-name") as HTMLInputElement)
        .value;
      const twitterHandle = (
        document.getElementById("twitter-handle") as HTMLInputElement
      ).value;

      try {
        await api.agents.create({
          name,
          twitterHandle: twitterHandle.replace("@", ""),
        });

        (e.target as HTMLFormElement).reset();
        loadAgents();
      } catch (error: any) {
        console.error("Error registering agent:", error);
        alert("Failed to register agent: " + error.message);
      }
    });

  const joinBtn = document.getElementById("join-queue-btn");
  if (joinBtn) joinBtn.addEventListener("click", joinQueue);

  const leaveBtn = document.getElementById("leave-queue-btn");
  if (leaveBtn) leaveBtn.addEventListener("click", leaveQueue);

  loadAgents();
</script>
